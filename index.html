<!DOCTYPE html>
<html>
<head>
  <title>Inside Sales Knowledge Assistant</title>
  <link rel="icon" href="data:,">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f7f7f7;
    }
    h3 { margin-bottom: 10px; }
    input {
      width: 70%;
      padding: 10px;
      font-size: 14px;
    }
    button {
      padding: 10px 16px;
      margin-left: 5px;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    pre {
      background: #ffffff;
      padding: 15px;
      margin-top: 15px;
      border-radius: 5px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

<h3>Inside Sales Knowledge Assistant</h3>

<input id="q" placeholder="Ask from SOP / Package / Policyâ€¦" />
<button id="askBtn" disabled>Ask</button>

<pre id="a">Loading knowledge baseâ€¦ please wait.</pre>

<script type="module">
/* ======================================================
   CONFIG
====================================================== */
const SHEET_ID = "11271sFaBgw1Wwc9t4sif3NS0gfitqaPQWgO3tCcTY9M";
const TAB_INDEX_NAME = "Tabs";
const SIMILARITY_THRESHOLD = 0.15;

/* ======================================================
   GLOBAL STORE
====================================================== */
let docs = [];

/* ======================================================
   LOAD TAB NAMES (SAFE)
====================================================== */
async function loadTabNames() {
  const res = await fetch(
    `https://opensheet.elk.sh/${SHEET_ID}/${TAB_INDEX_NAME}`
  );
  const rows = await res.json();

  return rows
    .map(r => typeof r.SheetName === "string" ? r.SheetName.trim() : "")
    .filter(Boolean);
}

/* ======================================================
   LOAD ALL TABS (BULLETPROOF)
====================================================== */
async function loadAllTabs() {
  const tabs = await loadTabNames();
  docs = [];

  for (const tab of tabs) {
    const cleanTab = tab.trim();
    const url = `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(cleanTab)}`;

    let rows;
    try {
      const res = await fetch(url);
      rows = await res.json();
    } catch {
      console.warn("Skipping tab (fetch failed):", cleanTab);
      continue;
    }

    if (!Array.isArray(rows)) {
      console.warn("Skipping tab (invalid JSON):", cleanTab);
      continue;
    }

    rows.forEach((row, i) => {
      const text = Object.values(row)
        .join(" ")
        .replace(/\s+/g, " ")
        .trim();

      if (text.length > 0) {
        docs.push({
          source: `[${cleanTab} | Row ${i + 2}]`,
          text
        });
      }
    });
  }
}

/* ======================================================
   SIMPLE TOKEN MATCH SCORING (STABLE)
====================================================== */
function tokenize(str) {
  return str.toLowerCase().split(/\W+/).filter(Boolean);
}

function score(query, docText) {
  const qTokens = tokenize(query);
  const dTokens = tokenize(docText);

  let hits = 0;
  qTokens.forEach(t => {
    if (dTokens.includes(t)) hits++;
  });

  return hits / Math.sqrt(dTokens.length + 1);
}

/* ======================================================
   INIT
====================================================== */
await loadAllTabs();

document.getElementById("a").innerText =
  "Knowledge base loaded. You can start asking questions.";

const askBtn = document.getElementById("askBtn");
askBtn.disabled = false;

/* ======================================================
   ASK HANDLER â€” FINAL, CLEAN OUTPUT
====================================================== */
askBtn.addEventListener("click", () => {
  const q = document.getElementById("q").value.trim();
  if (!q) return;

  const ranked = docs
    .map(d => ({
      ...d,
      score: score(q, d.text)
    }))
    .sort((a, b) => b.score - a.score);

  if (!ranked.length || ranked[0].score < SIMILARITY_THRESHOLD) {
    document.getElementById("a").innerText =
      "I don't have that information.";
    return;
  }

  // ðŸ”’ Clean answer: ONLY sheet content, no AI hallucination
  const answer = ranked
    .slice(0, 3)
    .map(r => `â€¢ ${r.text}`)
    .join("\n\n");

  const sources = ranked
    .slice(0, 3)
    .map(r => r.source)
    .join("\n");

  document.getElementById("a").innerText =
    answer + "\n\nSource:\n" + sources;
});
</script>

</body>
</html>
