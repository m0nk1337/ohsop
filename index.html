<!DOCTYPE html>
<html>
<head>
  <title>Inside Sales Knowledge Assistant (AI)</title>
  <link rel="icon" href="data:,">

  <style>
    body { font-family: Arial; padding: 20px; background: #f7f7f7; }
    input { width: 70%; padding: 10px; }
    button { padding: 10px 16px; margin-left: 5px; }
    pre { background: #fff; padding: 15px; margin-top: 15px; border-radius: 5px; white-space: pre-wrap; }
  </style>
</head>

<body>

<h3>Inside Sales Knowledge Assistant (Gemini)</h3>

<input id="q" placeholder="Ask anything about packages / SOP / policy…" />
<button onclick="ask()">Ask</button>

<pre id="a">Ready.</pre>

<script>
const API_KEY = "AIzaSyDASIlc-6KDR5dniCMPh_WLMFYM8tm_oOk";
const SHEET_ID = "11271sFaBgw1Wwc9t4sif3NS0gfitqaPQWgO3tCcTY9M";
const TAB_INDEX_NAME = "Tabs";

async function loadAllSheetText() {
  const tabsRes = await fetch(
    `https://opensheet.elk.sh/${SHEET_ID}/${TAB_INDEX_NAME}`
  );
  const tabs = await tabsRes.json();

  let text = "";

  for (const t of tabs) {
    const name = t.SheetName?.trim();
    if (!name) continue;

    const res = await fetch(
      `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(name)}`
    );
    const rows = await res.json();
    if (!Array.isArray(rows)) continue;

    rows.forEach(r => {
      text += Object.values(r).join(" ") + "\n";
    });
  }

  return text;
}

async function ask() {
  const q = document.getElementById("q").value.trim();
  if (!q) return;

  document.getElementById("a").innerText = "Thinking…";

  const sheetData = await loadAllSheetText();

  const prompt = `
You are an internal knowledge assistant.

RULES:
- Answer ONLY using the provided data
- If the answer is not present, say exactly:
"I don't have that information."
- Do NOT guess or add external knowledge

DATA:
${sheetData}

QUESTION:
${q}
`;

  const res = await fetch(
    "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + API_KEY,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }]
      })
    }
  );

  const json = await res.json();
  const answer =
    json.candidates?.[0]?.content?.parts?.[0]?.text ??
    "I don't have that information.";

  document.getElementById("a").innerText = answer;
}
</script>

</body>
</html>
