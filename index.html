<!DOCTYPE html>
<html>
<head>
  <title>Inside Sales Knowledge Assistant</title>
  <link rel="icon" href="data:,">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f7f7f7;
    }
    h3 {
      margin-bottom: 10px;
    }
    input {
      width: 70%;
      padding: 10px;
      font-size: 14px;
    }
    button {
      padding: 10px 16px;
      margin-left: 5px;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    pre {
      background: #ffffff;
      padding: 15px;
      margin-top: 15px;
      border-radius: 5px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

<h3>Inside Sales Knowledge Assistant</h3>

<input id="q" placeholder="Ask from SOP / Policy / Process..." />
<button id="askBtn" disabled>Ask</button>

<pre id="a">Loading knowledge baseâ€¦ please wait.</pre>

<script type="module">
import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.16.1";

/* ================= CONFIG ================= */
const SHEET_ID = "11271sFaBgw1Wwc9t4sif3NS0gfitqaPQWgO3tCcTY9M";
const TAB_INDEX_NAME = "Tabs";
const SIMILARITY_THRESHOLD = 0.15;
/* ========================================= */

let docs = [];

/* ---------- Load tab names ---------- */
async function loadTabNames() {
  const res = await fetch(
    `https://opensheet.elk.sh/${SHEET_ID}/${TAB_INDEX_NAME}`
  );
  const rows = await res.json();
  return rows
    .map(r => r.SheetName)
    .filter(name => typeof name === "string" && name.trim().length > 0)
    .map(name => name.trim()); // ðŸ”’ remove hidden spaces
}

/* ---------- Load all tabs safely ---------- */
async function loadAllTabs() {
  const tabs = await loadTabNames();
  docs = [];

  for (const tab of tabs) {
    const url = `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(tab)}`;

    let rows;
    try {
      const res = await fetch(url);
      rows = await res.json();
    } catch (e) {
      console.warn("Failed to fetch tab:", tab);
      continue;
    }

    if (!Array.isArray(rows)) {
      console.warn("Invalid data for tab:", tab, rows);
      continue;
    }

    rows.forEach((row, i) => {
      docs.push(
        `[${tab} | Row ${i + 2}] ${Object.values(row).join(" ")}`
      );
    });
  }
}

/* ---------- SIMPLE TOKEN MATCH SCORING ---------- */
function tokenize(text) {
  return text.toLowerCase().split(/\W+/).filter(Boolean);
}

function score(query, doc) {
  const qTokens = tokenize(query);
  const dTokens = tokenize(doc);
  let hits = 0;

  qTokens.forEach(t => {
    if (dTokens.includes(t)) hits++;
  });

  return hits / Math.sqrt(dTokens.length + 1);
}

/* ---------- LOAD GENERATION MODEL ONLY ---------- */
console.log("Loading generation model...");
const generator = await pipeline(
  "text-generation",
  "Xenova/distilgpt2"
);

/* ---------- INIT ---------- */
await loadAllTabs();

document.getElementById("a").innerText =
  "Knowledge base loaded. You can start asking questions.";

const askBtn = document.getElementById("askBtn");
askBtn.disabled = false;

/* ---------- ASK ---------- */
askBtn.addEventListener("click", async () => {
  const q = document.getElementById("q").value.trim();
  if (!q) return;

  const ranked = docs
    .map(d => ({ text: d, score: score(q, d) }))
    .sort((a, b) => b.score - a.score);

  if (!ranked.length || ranked[0].score < SIMILARITY_THRESHOLD) {
    document.getElementById("a").innerText =
      "I don't have that information.";
    return;
  }

  const context = ranked
    .slice(0, 3)
    .map(r => r.text)
    .join("\n");

  const prompt = `
Answer ONLY using the context below.
If the answer is not present, say:
"I don't have that information."

Context:
${context}

Question:
${q}
`;

  const out = await generator(prompt, { max_new_tokens: 100 });

  document.getElementById("a").innerText =
    out[0].generated_text +
    "\n\nSource:\n" +
    ranked.slice(0, 3).map(r => r.text.split("]")[0] + "]").join("\n");
});
</script>

</body>
</html>
