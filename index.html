<!DOCTYPE html>
<html>
<head>
  <title>Inside Sales Knowledge Assistant</title>
  <link rel="icon" href="data:,">

  <style>
    body { font-family: Arial; padding: 20px; background: #f7f7f7; }
    input { width: 70%; padding: 10px; }
    button { padding: 10px 16px; margin-left: 5px; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    pre { background: #fff; padding: 15px; margin-top: 15px; border-radius: 5px; white-space: pre-wrap; }
  </style>
</head>

<body>

<h3>Inside Sales Knowledge Assistant</h3>

<input id="q" placeholder="Ask from SOP / Policy / Process..." />
<button id="askBtn" disabled>Ask</button>

<pre id="a">Loading knowledge baseâ€¦ please wait.</pre>

<script type="module">
import { pipeline, env } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.16.1";

/* ================= HARD ENV RESET (SAFE) ================= */
env.allowLocalModels = false;
env.useBrowserCache = false;

/* ðŸ”‘ CRITICAL FIX */
env.localModelPath = "";              // â† NOT null
env.remoteHost = "https://huggingface.co";
env.remotePathTemplate = "{model}/resolve/main/";
/* ======================================================== */

const SHEET_ID = "11271sFaBgw1Wwc9t4sif3NS0gfitqaPQWgO3tCcTY9M";
const TAB_INDEX_NAME = "Tabs";
const SIMILARITY_THRESHOLD = 0.28;

let docs = [];
let vectors = [];

/* ---------- Load tab names ---------- */
async function loadTabNames() {
  const res = await fetch(
    `https://opensheet.elk.sh/${SHEET_ID}/${TAB_INDEX_NAME}`
  );
  const rows = await res.json();
  return rows.map(r => r.SheetName).filter(Boolean);
}

/* ---------- Load all tabs ---------- */
async function loadAllTabs() {
  const tabs = await loadTabNames();
  docs = [];

  for (const tab of tabs) {
    const res = await fetch(
      `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(tab)}`
    );
    const rows = await res.json();

    rows.forEach((row, i) => {
      docs.push(
        `[${tab} | Row ${i + 2}] ${Object.values(row).join(" : ")}`
      );
    });
  }
}

/* ---------- MODELS ---------- */
console.log("Loading embedding model...");
const embedder = await pipeline(
  "feature-extraction",
  "Xenova/all-MiniLM-L6-v2"
);

console.log("Loading generation model...");
const generator = await pipeline(
  "text-generation",
  "Xenova/distilgpt2"
);

/* ---------- Cosine similarity ---------- */
function cosine(a, b) {
  return a.reduce((s, v, i) => s + v * b[i], 0);
}

/* ---------- Index ---------- */
async function indexDocs() {
  vectors = await Promise.all(
    docs.map(d => embedder(d, { pooling: "mean", normalize: true }))
  );
}

/* ---------- INIT ---------- */
await loadAllTabs();
await indexDocs();

document.getElementById("a").innerText =
  "Knowledge base loaded. You can start asking questions.";

const askBtn = document.getElementById("askBtn");
askBtn.disabled = false;

/* ---------- ASK ---------- */
askBtn.addEventListener("click", async () => {
  const q = document.getElementById("q").value.trim();
  if (!q) return;

  const qVec = await embedder(q, { pooling: "mean", normalize: true });

  const scored = vectors.map((v, i) => ({
    text: docs[i],
    score: cosine(v.data, qVec.data)
  })).sort((a, b) => b.score - a.score);

  if (!scored.length || scored[0].score < SIMILARITY_THRESHOLD) {
    document.getElementById("a").innerText =
      "I don't have that information.";
    return;
  }

  const top = scored.slice(0, 3);
  const context = top.map(s => s.text).join("\n");

  const prompt = `
Answer ONLY using the context below.
If the answer is not present, say:
"I don't have that information."

Context:
${context}

Question:
${q}
`;

  const out = await generator(prompt, { max_new_tokens: 100 });
  document.getElementById("a").innerText = out[0].generated_text;
});
</script>

</body>
</html>
